name: CI/CD Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Tag
        id: set-tag
        run: echo "::set-output name=tag::${GITHUB_SHA::7}"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build and push images
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          chmod +x ./scripts/push-ecr-images.sh
          ./scripts/push-ecr-images.sh "${AWS_ACCOUNT_ID}" "${AWS_REGION}" "${TAG}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, auth-service, user-service, product-service, cart-service, order-service, payment-service, search-service, review-service, email-service]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Service
        run: echo "Deploying ${{ matrix.service }}"

      - name: Deploy to host (SSH)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets[ format('HOST_{0}', matrix.service | upper | replace('-', '_') ) ] }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            chmod +x /opt/microservices/remote-deploy.sh
            /opt/microservices/remote-deploy.sh "${{ matrix.service }}" "${{ secrets.AWS_ACCOUNT_ID }}" "${{ secrets.AWS_REGION }}" "${{ needs.build-and-push.outputs.image-tag }}"
