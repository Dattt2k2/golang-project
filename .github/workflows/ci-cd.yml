name: CI/CD Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Tag
        id: set-tag
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build and push images
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          TAG: ${{ steps.set-tag.outputs.tag }}
        run: |
          chmod +x ./scripts/push-ecr-images.sh
          ./scripts/push-ecr-images.sh "${AWS_ACCOUNT_ID}" "${AWS_REGION}" "${TAG}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, auth-service, user-service, product-service, cart-service, order-service, payment-service, search-service, review-service, email-service]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Service
        run: echo "Deploying ${{ matrix.service }}"

      - name: Deploy to host via SSH
        env:
          SERVICE_NAME: ${{ matrix.service }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
        run: |
          # Convert service name to uppercase + replace '-' with '_'
          HOST_SECRET_NAME=$(echo "$SERVICE_NAME" | tr '[:lower:]-' '[:upper:]_')
          
          # Access the corresponding secret dynamically
          case "$HOST_SECRET_NAME" in
            API_GATEWAY) HOST=${{ secrets.HOST_API_GATEWAY }} ;;
            AUTH_SERVICE) HOST=${{ secrets.HOST_AUTH_SERVICE }} ;;
            USER_SERVICE) HOST=${{ secrets.HOST_USER_SERVICE }} ;;
            PRODUCT_SERVICE) HOST=${{ secrets.HOST_PRODUCT_SERVICE }} ;;
            CART_SERVICE) HOST=${{ secrets.HOST_CART_SERVICE }} ;;
            ORDER_SERVICE) HOST=${{ secrets.HOST_ORDER_SERVICE }} ;;
            PAYMENT_SERVICE) HOST=${{ secrets.HOST_PAYMENT_SERVICE }} ;;
            SEARCH_SERVICE) HOST=${{ secrets.HOST_SEARCH_SERVICE }} ;;
            REVIEW_SERVICE) HOST=${{ secrets.HOST_REVIEW_SERVICE }} ;;
            EMAIL_SERVICE) HOST=${{ secrets.HOST_EMAIL_SERVICE }} ;;
            *) echo "Unknown service: $SERVICE_NAME"; exit 1 ;;
          esac

          echo "Deploying $SERVICE_NAME to host $HOST"

          # SSH deploy
          chmod +x /opt/microservices/remote-deploy.sh
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$SSH_USER@$HOST" \
            "/opt/microservices/remote-deploy.sh '$SERVICE_NAME' '$AWS_ACCOUNT_ID' '$AWS_REGION' '$IMAGE_TAG'"
